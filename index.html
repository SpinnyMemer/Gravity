<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gravity Hub - Key System</title>
    <script src="https://publisher.linkvertise.com/cdn/linkvertise.js"></script>
    <style>
        /* (kept your original CSS with small additions for modal) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 650px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .header { text-align: center; margin-bottom: 30px; }
        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; font-size: 2.5em; margin-bottom: 5px;
        }
        .subtitle { color: #666; font-size: 0.9em; }
        .step { display: none; animation: fadeIn 0.3s; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hwid-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;
        }
        .hwid-display strong { font-size: 0.9em; opacity: 0.9; }
        .hwid-display .hwid-value { font-family: 'Courier New', monospace; font-size: 1.1em; margin-top: 5px; word-break: break-all; font-weight: 600; }
        button {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 10px;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .link-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .link-btn { margin: 0; display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 20px 14px; }
        .link-btn.linkvertise { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .link-btn.workink { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .link-btn .icon { font-size: 2em; } .link-btn .label { font-size: 0.9em; }
        .info-box { background: #f0f4ff; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .info-box p { margin: 5px 0; color: #555; font-size: 0.9em; }
        .checkpoint { display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 8px; margin: 10px 0; border: 2px solid #e0e0e0; }
        .checkpoint.completed { border-color: #48bb78; background: #f0fff4; }
        .checkpoint-number { width: 40px; height: 40px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666; flex-shrink: 0; }
        .checkpoint.completed .checkpoint-number { background: #48bb78; color: white; }
        .checkpoint-content { flex: 1; } .checkpoint-title { font-weight: 600; color: #2d3748; margin-bottom: 3px; }
        .checkpoint-status { font-size: 0.85em; color: #666; } .checkpoint.completed .checkpoint-status { color: #48bb78; }
        .key-display { background: #2d3748; color: #68d391; padding: 20px 15px 15px; border-radius: 8px; font-family: 'Courier New', monospace; word-break: break-all; margin: 20px 0; position: relative; font-size: 0.95em; }
        .copy-btn { position: absolute; top: 10px; right: 10px; padding: 5px 15px; font-size: 12px; width: auto; margin: 0; }
        .success { color: #48bb78; text-align: center; margin: 10px 0; font-weight: 600; } .error { color: #f56565; text-align: center; margin: 10px 0; font-weight: 600; }
        .warning { background: #fff5e6; border-left: 4px solid #ff9800; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .warning p { margin: 5px 0; color: #e65100; font-size: 0.9em; }
        .status { text-align: center; font-size: 0.9em; color: #666; margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 5px; }
        .progress-bar { width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s; }
        .step-indicator { display: flex; justify-content: space-around; margin-bottom: 30px; font-size: 0.85em; }
        .step-indicator span { color: #999; } .step-indicator span.active { color: #667eea; font-weight: 600; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 3px solid rgba(102, 126, 234, 0.3); border-radius: 50%; border-top-color: #667eea; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .shield-icon { font-size: 3em; text-align: center; margin: 20px 0; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .loading-overlay.active { display: flex; } .loading-content { background: white; padding: 30px; border-radius: 10px; text-align: center; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid rgba(102, 126, 234, 0.3); border-radius: 50%; border-top-color: #667eea; animation: spin 1s ease-in-out infinite; margin: 0 auto 15px; }

        /* AdBlock modal specific */
        .adblock-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center; align-items: center;
        }
        .adblock-modal .modal-inner {
            background: #fff; padding: 22px; border-radius: 10px; max-width: 460px; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .adblock-modal .modal-inner h2 { margin-bottom: 8px; font-size: 1.3em; }
        .adblock-modal .modal-inner p { color: #555; margin-bottom: 12px; }
        .adblock-modal .btns { display:flex; gap:10px; justify-content:center; }
        .adblock-modal .btns button { width:auto; padding:10px 16px; border-radius:8px; }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Loading your session...</p>
        </div>
    </div>

    <!-- AdBlock modal -->
    <div class="adblock-modal" id="adblockModal" role="dialog" aria-modal="true">
        <div class="modal-inner">
            <h2>‚ö†Ô∏è AdBlock Detected</h2>
            <p>We detected an ad blocker that might prevent Linkvertise and other verification links from working correctly. Please disable AdBlock for this site to continue.</p>
            <div class="btns">
                <button id="adblockRetry">I disabled AdBlock (Retry)</button>
                <button id="adblockContinue">Continue anyway</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üåå Gravity Hub</h1>
            <p class="subtitle">Key System - Complete 2 checkpoints to get your key</p>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="step-indicator">
            <span id="indicator1" class="active">Checkpoint 1</span>
            <span id="indicator2">Checkpoint 2</span>
            <span id="indicator3">Get Key</span>
        </div>

        <!-- Step 1 -->
        <div class="step active" id="step1">
            <div class="hwid-display">
                <strong>Your HWID:</strong>
                <div class="hwid-value" id="hwidDisplay">Loading...</div>
            </div>

            <div class="info-box">
                <p><strong>üõ°Ô∏è Checkpoint 1 of 2</strong></p>
                <p>Choose your preferred verification method. Both options are secure and have anti-bypass protection.</p>
            </div>

            <div class="link-buttons">
                <button class="link-btn linkvertise" onclick="startCheckpoint(1, 'linkvertise')" id="lv1Btn">
                    <span class="icon">üîó</span>
                    <span class="label">Linkvertise</span>
                </button>
                <button class="link-btn workink" onclick="startCheckpoint(1, 'workink')" id="wi1Btn">
                    <span class="icon">üíº</span>
                    <span class="label">Work.ink</span>
                </button>
            </div>

            <div class="status" id="status1">Select a verification method to continue</div>
            <p class="error" id="error1"></p>
        </div>

        <!-- Step 2 -->
        <div class="step" id="step2">
            <div class="hwid-display">
                <strong>Your HWID:</strong>
                <div class="hwid-value" id="hwidDisplay2">Loading...</div>
            </div>

            <div class="checkpoint completed">
                <div class="checkpoint-number">‚úì</div>
                <div class="checkpoint-content">
                    <div class="checkpoint-title">Checkpoint 1 Complete</div>
                    <div class="checkpoint-status" id="checkpoint1Info">Verified successfully</div>
                </div>
            </div>

            <div class="checkpoint">
                <div class="checkpoint-number">2</div>
                <div class="checkpoint-content">
                    <div class="checkpoint-title">Checkpoint 2</div>
                    <div class="checkpoint-status">Complete second verification</div>
                </div>
            </div>

            <div class="info-box">
                <p><strong>üõ°Ô∏è Final Checkpoint</strong></p>
                <p>Complete one more verification to generate your Gravity Hub key.</p>
            </div>

            <div class="link-buttons">
                <button class="link-btn linkvertise" onclick="startCheckpoint(2, 'linkvertise')" id="lv2Btn">
                    <span class="icon">üîó</span>
                    <span class="label">Linkvertise</span>
                </button>
                <button class="link-btn workink" onclick="startCheckpoint(2, 'workink')" id="wi2Btn">
                    <span class="icon">üíº</span>
                    <span class="label">Work.ink</span>
                </button>
            </div>

            <div class="status" id="status2">Select a verification method to continue</div>
            <p class="error" id="error2"></p>
        </div>

        <!-- Step 3 -->
        <div class="step" id="step3">
            <div class="shield-icon">üõ°Ô∏è</div>

            <div class="checkpoint completed">
                <div class="checkpoint-number">‚úì</div>
                <div class="checkpoint-content">
                    <div class="checkpoint-title">Checkpoint 1 Complete</div>
                    <div class="checkpoint-status" id="finalCheckpoint1">Verified</div>
                </div>
            </div>

            <div class="checkpoint completed">
                <div class="checkpoint-number">‚úì</div>
                <div class="checkpoint-content">
                    <div class="checkpoint-title">Checkpoint 2 Complete</div>
                    <div class="checkpoint-status" id="finalCheckpoint2">Verified</div>
                </div>
            </div>

            <div class="info-box">
                <p><strong>‚úÖ All Checkpoints Completed!</strong></p>
                <p>Your Gravity Hub key has been generated and is valid for 24 hours.</p>
            </div>

            <div class="key-display">
                <button class="copy-btn" onclick="copyKey()">Copy</button>
                <div id="keyText"></div>
            </div>

            <div class="info-box">
                <p><strong>HWID:</strong> <span id="displayHWID"></span></p>
                <p><strong>Generated:</strong> <span id="generatedTime"></span></p>
                <p><strong>Expires:</strong> <span id="expiryTime"></span></p>
            </div>
            <p class="success" id="copySuccess"></p>
        </div>

        <!-- No HWID Warning -->
        <div class="step" id="stepError">
            <div class="warning">
                <p><strong>‚ö†Ô∏è No HWID Detected</strong></p>
                <p>Please open this page from Gravity Hub by clicking the "Get Key" button in the script.</p>
            </div>
            <div class="info-box">
                <p><strong>The correct URL format should be:</strong></p>
                <p style="font-family: monospace; background: white; padding: 8px; border-radius: 4px; margin-top: 8px;">
                    https://yourusername.github.io/gravity-hub-key/?hwid=YOUR_HWID_HERE
                </p>
            </div>
        </div>
    </div>

    <script>
        /* CONFIG */
        const CONFIG = {
            linkvertise: {
                userId: 1347978,
                // Note: token present earlier is client-side sensitive ‚Äî real Linkvertise API usage should be server-side.
                token: 'c29c8d68870394fbdaf3b23e39c7c82deae31da2186cbb7d79b90905eb17366c'
            },
            workink: {
                apiKey: 'ed6e8e30-c81a-40b4-8694-463650bacd58',
                domain: 'work.ink'
            },
            storage: {
                keyPrefix: 'gravityhub_',
                expiryHours: 24
            }
        };

        let userData = {
            hwid: '',
            ipHash: '',
            checkpoint1: { completed: false, provider: null },
            checkpoint2: { completed: false, provider: null },
            key: '',
            expiry: null
        };

        let checkInterval = null;

        function getHWIDFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('hwid');
        }

        async function getIPHash() {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 4000);
            try {
                const response = await fetch('https://api.ipify.org?format=json', { signal: controller.signal });
                const data = await response.json();
                clearTimeout(timeout);
                const encoder = new TextEncoder();
                const dataBuffer = encoder.encode(data.ip + navigator.userAgent);
                const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
            } catch {
                clearTimeout(timeout);
                return Math.random().toString(36).substring(2, 18);
            }
        }

        function saveKeyData() {
            const storageKey = CONFIG.storage.keyPrefix + userData.ipHash;
            const data = {
                hwid: userData.hwid,
                checkpoint1: userData.checkpoint1,
                checkpoint2: userData.checkpoint2,
                key: userData.key,
                expiry: userData.expiry,
                timestamp: Date.now()
            };
            try { localStorage.setItem(storageKey, JSON.stringify(data)); } catch (e) { console.warn('localStorage unavailable', e); }
        }

        function loadKeyData() {
            const storageKey = CONFIG.storage.keyPrefix + userData.ipHash;
            const savedData = localStorage.getItem(storageKey);
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    const expiry = new Date(data.expiry);
                    
                    if (expiry > new Date() && data.hwid === userData.hwid) {
                        userData.checkpoint1 = data.checkpoint1;
                        userData.checkpoint2 = data.checkpoint2;
                        userData.key = data.key;
                        userData.expiry = expiry;
                        return true;
                    } else {
                        localStorage.removeItem(storageKey);
                    }
                } catch (error) {
                    console.error('Failed to load saved key:', error);
                    localStorage.removeItem(storageKey);
                }
            }
            return false;
        }

        /* Initialize Linkvertise lib if available */
        function initializeLinkvertise() {
            try {
                if (typeof linkvertise === 'function') {
                    linkvertise(CONFIG.linkvertise.userId, { whitelist: [], blacklist: [""] });
                }
            } catch (e) {
                console.warn('Linkvertise initialization failed', e);
            }
        }

        /* AD BLOCK DETECTION (bait element method) */
        function detectAdBlock(showModalIfDetected = true) {
            return new Promise((resolve) => {
                const adTest = document.createElement('div');
                adTest.className = 'adsbox';
                // some adblockers hide elements by class names like .ads, .adsbox, etc.
                adTest.style.position = 'absolute';
                adTest.style.left = '-9999px';
                adTest.style.height = '1px';
                document.body.appendChild(adTest);

                setTimeout(() => {
                    const blocked = (adTest.offsetParent === null) || (adTest.offsetHeight === 0) || (getComputedStyle(adTest).display === 'none');
                    document.body.removeChild(adTest);
                    if (blocked && showModalIfDetected) {
                        showAdblockModal();
                    }
                    resolve(blocked);
                }, 150);
            });
        }

        function showAdblockModal() {
            const modal = document.getElementById('adblockModal');
            modal.style.display = 'flex';
        }
        function hideAdblockModal() {
            const modal = document.getElementById('adblockModal');
            modal.style.display = 'none';
        }

        /* Utility functions */
        function generateSessionId() {
            return Math.random().toString(36).substring(2, 15) + Date.now().toString(36);
        }

        /* Create Linkvertise link (improved fallback)
           NOTE: Proper Linkvertise link creation should use their server-side API. 
           Here we attempt a helpful fallback URL that encodes the callback. If you need real monetization/tracking,
           create links server-side via Linkvertise API and return the produced 'link' to the client.
        */
        async function createLinkvertiseLink(checkpointNum) {
            const callbackUrl = window.location.origin + window.location.pathname + 
                `?hwid=${encodeURIComponent(userData.hwid)}&cp${checkpointNum}=lv&t=${Date.now()}`;
            const encoded = btoa(callbackUrl);

            // Fallback public URL pattern ‚Äî this does not guarantee Linkvertise's tracking will treat it as a created link.
            // If Linkvertise provides a JS function to generate links client-side for your publisher account, prefer that.
            // For now, return a predictable encoded URL that will redirect back with cpN param when user returns.
            return `https://linkvertise.com/${CONFIG.linkvertise.userId}/gravityhub-cp${checkpointNum}?r=${encoded}`;
        }

        /* Create Work.ink link (keeps existing approach with fallback) */
        async function createWorkinkLink(checkpointNum) {
            const callbackUrl = window.location.origin + window.location.pathname + 
                `?hwid=${encodeURIComponent(userData.hwid)}&cp${checkpointNum}=wi&t=${Date.now()}`;
            
            try {
                const customAlias = `gh-${generateSessionId()}`;

                const response = await fetch('https://dashboard.work.ink/_api/v1/link', {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': CONFIG.workink.apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: `Gravity Hub - Checkpoint ${checkpointNum}`,
                        link_description: 'Complete this verification to proceed with Gravity Hub key generation',
                        destination: callbackUrl,
                        f_domain: CONFIG.workink.domain,
                        custom: customAlias
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.short_url || data.url || `https://${CONFIG.workink.domain}/${customAlias}`;
                } else {
                    console.error('Work.ink API error:', await response.text());
                    return `https://${CONFIG.workink.domain}/${customAlias}`;
                }
            } catch (error) {
                console.error('Work.ink API error:', error);
                const fallbackAlias = generateSessionId();
                return `https://${CONFIG.workink.domain}/${fallbackAlias}`;
            }
        }

        /* Start checkpoint flow: disable buttons, create link, open and start polling */
        async function startCheckpoint(checkpointNum, provider) {
            const statusEl = document.getElementById(`status${checkpointNum}`);
            const errorEl = document.getElementById(`error${checkpointNum}`);

            document.querySelectorAll('.link-btn').forEach(btn => btn.disabled = true);
            statusEl.innerHTML = `<span class="spinner"></span> Creating ${provider} link...`;
            errorEl.textContent = '';

            try {
                let verifyUrl = null;
                if (provider === 'linkvertise') {
                    // If AdBlock is detected, Linkvertise pages might be blocked. Try to warn user if so.
                    const blocked = await detectAdBlock(false);
                    if (blocked) {
                        // show modal (non-blocking) to encourage disabling adblock
                        showAdblockModal();
                    }
                    verifyUrl = await createLinkvertiseLink(checkpointNum);
                } else if (provider === 'workink') {
                    verifyUrl = await createWorkinkLink(checkpointNum);
                }

                if (verifyUrl) {
                    // open in new tab
                    window.open(verifyUrl, '_blank', 'noopener');

                    statusEl.innerHTML = `‚è≥ Complete the ${provider} verification in the new window...<br><small>This page will detect completion when you return</small>`;
                    startVerificationCheck(checkpointNum, provider);
                } else {
                    throw new Error('Failed to create verification link');
                }
                
            } catch (error) {
                console.error('Error creating verification link:', error);
                errorEl.textContent = 'Failed to create verification link. Please try again.';
                document.querySelectorAll('.link-btn').forEach(btn => btn.disabled = false);
            }
        }

        /* Polling for verification completion by checking URL params (cp1 / cp2)
           Uses a safe interval and clears it on success or timeout */
        function startVerificationCheck(checkpointNum, provider) {
            clearInterval(checkInterval);
            let attempts = 0;
            const maxAttempts = 120; // up to ~10 minutes (120 * 5s)
            
            checkInterval = setInterval(() => {
                attempts++;
                // Re-evaluate URL params
                const urlParams = new URLSearchParams(window.location.search);
                const cpParam = urlParams.get(`cp${checkpointNum}`);

                if (cpParam === 'lv' || cpParam === 'wi') {
                    clearInterval(checkInterval);
                    handleCheckpointSuccess(checkpointNum, provider);
                    return;
                }

                const timeElapsed = Math.floor(attempts * 5);
                const statusEl = document.getElementById(`status${checkpointNum}`);
                if (statusEl) {
                    statusEl.innerHTML = `‚è≥ Waiting for verification... (${timeElapsed}s)<br><small>Return to this page after completing ${provider}</small>`;
                }

                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    document.getElementById(`error${checkpointNum}`).textContent = 'Verification timeout. Please try again.';
                    document.querySelectorAll('.link-btn').forEach(btn => btn.disabled = false);
                }
            }, 5000);
        }

        /* Handle success once cp parameter is present in URL */
        function handleCheckpointSuccess(checkpointNum, provider) {
            const providerName = provider === 'linkvertise' ? 'Linkvertise' : 'Work.ink';
            
            if (checkpointNum === 1) {
                userData.checkpoint1.completed = true;
                userData.checkpoint1.provider = providerName;
                document.getElementById('checkpoint1Info').textContent = `Verified via ${providerName}`;

                // Clean the URL to just hwid and cp1
                const cleanUrl = window.location.origin + window.location.pathname + 
                    `?hwid=${encodeURIComponent(userData.hwid)}&cp1=${provider === 'linkvertise' ? 'lv' : 'wi'}`;
                window.history.replaceState({}, document.title, cleanUrl);

                // Enable buttons again for next step
                document.querySelectorAll('.link-btn').forEach(btn => btn.disabled = false);

                goToStep(2);
            } else if (checkpointNum === 2) {
                userData.checkpoint2.completed = true;
                userData.checkpoint2.provider = providerName;

                generateKey();
                saveKeyData();

                // Clean URL to show cp1 and cp2
                const cleanUrl = window.location.origin + window.location.pathname + 
                    `?hwid=${encodeURIComponent(userData.hwid)}&cp1=${userData.checkpoint1.provider === 'Linkvertise' ? 'lv' : 'wi'}&cp2=${provider === 'linkvertise' ? 'lv' : 'wi'}`;
                window.history.replaceState({}, document.title, cleanUrl);

                document.querySelectorAll('.link-btn').forEach(btn => btn.disabled = false);
                goToStep(3);
            }
        }

        /* Check URL params on load in case user returned from provider directly to this page */
        function checkVerificationStatusOnLoad() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('cp1')) {
                userData.checkpoint1.completed = true;
                userData.checkpoint1.provider = urlParams.get('cp1') === 'lv' ? 'Linkvertise' : 'Work.ink';
            }
            
            if (urlParams.get('cp2')) {
                userData.checkpoint2.completed = true;
                userData.checkpoint2.provider = urlParams.get('cp2') === 'lv' ? 'Linkvertise' : 'Work.ink';
            }
            
            if (userData.checkpoint1.completed && !userData.checkpoint2.completed) {
                document.getElementById('checkpoint1Info').textContent = `Verified via ${userData.checkpoint1.provider}`;
                goToStep(2);
            } else if (userData.checkpoint1.completed && userData.checkpoint2.completed) {
                generateKey();
                saveKeyData();
                goToStep(3);
            }
        }

        /* Generate the key (same logic) */
        function generateKey() {
            const timestamp = Date.now();
            const randomPart = Math.random().toString(36).substring(2, 10).toUpperCase();
            const hwidHash = btoa(userData.hwid).substring(0, 8).toUpperCase();
            const cp1Hash = btoa(userData.checkpoint1.provider || '').substring(0, 4).toUpperCase();
            const cp2Hash = btoa(userData.checkpoint2.provider || '').substring(0, 4).toUpperCase();
            
            userData.key = `GRVT-${hwidHash}-${cp1Hash}${cp2Hash}-${randomPart}-${timestamp.toString(36).toUpperCase()}`;
            userData.expiry = new Date(timestamp + CONFIG.storage.expiryHours * 60 * 60 * 1000);
            
            const now = new Date(timestamp);

            document.getElementById('keyText').textContent = userData.key;
            document.getElementById('displayHWID').textContent = userData.hwid;
            document.getElementById('generatedTime').textContent = now.toLocaleString();
            document.getElementById('expiryTime').textContent = userData.expiry.toLocaleString();
            
            document.getElementById('finalCheckpoint1').textContent = `Verified via ${userData.checkpoint1.provider}`;
            document.getElementById('finalCheckpoint2').textContent = `Verified via ${userData.checkpoint2.provider}`;

            console.log('Gravity Hub Key generated:', {
                key: userData.key,
                hwid: userData.hwid,
                ipHash: userData.ipHash,
                checkpoint1: userData.checkpoint1,
                checkpoint2: userData.checkpoint2,
                generated: now.toISOString(),
                expiry: userData.expiry.toISOString()
            });
        }

        /* Copy key to clipboard */
        function copyKey() {
            const keyText = document.getElementById('keyText').textContent;
            if (!keyText) return;
            navigator.clipboard.writeText(keyText).then(() => {
                document.getElementById('copySuccess').textContent = '‚úì Key copied to clipboard!';
                setTimeout(() => { document.getElementById('copySuccess').textContent = ''; }, 3000);
            }).catch((e) => {
                console.warn('Clipboard write failed', e);
            });
        }

        /* Navigation utility to switch steps */
        function goToStep(stepNum) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${stepNum}`).classList.add('active');

            document.querySelectorAll('.step-indicator span').forEach(s => s.classList.remove('active'));
            const indicator = document.getElementById(`indicator${stepNum}`);
            if (indicator) indicator.classList.add('active');

            const progress = (stepNum / 3) * 100;
            const fill = document.getElementById('progressFill');
            if (fill) fill.style.width = progress + '%';
        }

        /* Display saved key data if present */
        function displaySavedKey() {
            const now = new Date();
            document.getElementById('keyText').textContent = userData.key;
            document.getElementById('displayHWID').textContent = userData.hwid;
            document.getElementById('generatedTime').textContent = new Date(userData.expiry.getTime() - 24 * 60 * 60 * 1000).toLocaleString();
            document.getElementById('expiryTime').textContent = userData.expiry.toLocaleString();
            document.getElementById('finalCheckpoint1').textContent = `Verified via ${userData.checkpoint1.provider}`;
            document.getElementById('finalCheckpoint2').textContent = `Verified via ${userData.checkpoint2.provider}`;
        }

        /* MAIN onload */
        window.onload = async function() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');

            // wire adblock modal buttons
            document.getElementById('adblockRetry').addEventListener('click', async () => {
                hideAdblockModal();
                const blocked = await detectAdBlock(false);
                if (!blocked) {
                    // user likely disabled adblock
                    initializeLinkvertise();
                    alert('Thanks ‚Äî AdBlock looks disabled now. Try the Linkvertise button again.');
                } else {
                    alert('AdBlock still detected. Please disable it and retry.');
                }
            });
            document.getElementById('adblockContinue').addEventListener('click', () => {
                hideAdblockModal();
            });

            const hwid = getHWIDFromURL();
            if (!hwid || hwid.trim() === '') {
                loadingOverlay.classList.remove('active');
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                document.getElementById('stepError').classList.add('active');
                document.querySelector('.progress-bar').style.display = 'none';
                document.querySelector('.step-indicator').style.display = 'none';
                return;
            }

            userData.hwid = hwid.trim();

            // safer IP hash generation with fallback
            try { userData.ipHash = await getIPHash(); } catch { userData.ipHash = Math.random().toString(36).substring(2, 18); }

            document.getElementById('hwidDisplay').textContent = userData.hwid;
            document.getElementById('hwidDisplay2').textContent = userData.hwid;

            initializeLinkvertise();

            // detect adblock but do not block the user ‚Äî show modal if detected
            detectAdBlock(true).then(blocked => {
                if (blocked) {
                    // modal shown in detectAdBlock
                    console.info('AdBlock detected');
                }
            });

            // load any saved key for this HWID/IP
            if (loadKeyData()) {
                displaySavedKey();
                goToStep(3);
            } else {
                // check if URL already contains cp1/cp2 flags (user returned directly)
                checkVerificationStatusOnLoad();
                document.getElementById('status1').textContent = 'Select a verification method to continue';
            }

            loadingOverlay.classList.remove('active');
        };

        /* Extra: listen for changes in the URL (if site is opened with params after creation) */
        window.addEventListener('popstate', () => {
            checkVerificationStatusOnLoad();
        });

    </script>
</body>
</html>
